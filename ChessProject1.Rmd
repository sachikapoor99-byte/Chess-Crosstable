---
title: "Chess Project 1 â€” Cross-Table to CSV"
author: "Sachi Kapoor"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
pkgs <- c("readr","stringr","dplyr","tibble","knitr","purrr")
to_install <- pkgs[!pkgs %in% rownames(installed.packages())]
if(length(to_install)) install.packages(to_install, dependencies = TRUE)
invisible(lapply(pkgs, require, character.only = TRUE))
```

## 1) Read the tournament text
```{r}
candidates <- c("tournamentinfo (1).txt","tournamentinfo.txt")
fname <- candidates[file.exists(candidates)][1]
stopifnot(!is.na(fname))
lines <- readr::read_lines(fname)
length(lines); lines[1:6]
```

## 2) Locate player blocks (each player = two lines)
```{r}
top_idx <- grep("^\\s*\\d+\\s*\\|", lines)
top_idx <- top_idx[lines[pmin(top_idx+1, length(lines))] %>% stringr::str_detect("R:")]
length(top_idx)
```

## 3) Helpers to parse fields from the two lines
```{r}
parse_player <- function(i){
  top <- lines[i]
  bot <- lines[i+1]
  pair_num <- as.integer(stringr::str_match(top, "^\\s*(\\d+)\\s*\\|")[,2])
  name <- stringr::str_match(top, "^\\s*\\d+\\s*\\|\\s*([^|]+?)\\s*\\|")[,2] %>% stringr::str_squish()
  total_pts <- stringr::str_match(top, "^\\s*\\d+\\s*\\|[^|]+\\|\\s*([0-9]+\\.?[0-9]?)\\s*\\|")[,2] %>% as.numeric()
  opp_nums <- stringr::str_match_all(top, "[WDLBXHUF]\\s*(\\d+)")[[1]]
  opp_ids  <- if(nrow(opp_nums)) as.integer(opp_nums[,2]) else integer(0)
  state <- stringr::str_match(bot, "^\\s*([A-Z]{2})\\s*\\|")[,2]
  pre_rating <- stringr::str_match(bot, "R:\\s*([0-9]+)")[,2] %>% as.integer()
tibble(pair_num, name, state, total_pts, pre_rating, opp_ids = list(opp_ids))
}
players_raw <- purrr::map_dfr(top_idx, parse_player)
knitr::kable(head(players_raw, 5), caption = "Raw parsed players (first 5)")
```

## 4) Compute average opponent pre-ratings
```{r}
rating_map <- players_raw %>% dplyr::select(pair_num, pre_rating)
avg_opp <- players_raw %>%
  dplyr::rowwise() %>%
  dplyr::mutate(
    opp_pre = list(rating_map$pre_rating[match(opp_ids, rating_map$pair_num)]),
    games   = sum(!is.na(unlist(opp_pre))),
    avg_opp_pre = ifelse(games > 0, mean(unlist(opp_pre), na.rm = TRUE), NA_real_)
  ) %>%
  dplyr::ungroup()
result <- avg_opp %>%
  dplyr::transmute(
    player_name  = name,
    player_state = state,
    total_points = total_pts,
    pre_rating   = pre_rating,
    avg_opp_pre  = round(avg_opp_pre)
  )
knitr::kable(head(result, 10), caption = "Output preview (first 10 players)")
```

## 5) Save CSV (submission file)
```{r}
readr::write_csv(result, "chess_players.csv")
list.files(pattern = "(ChessProject1|html|csv)$")
```

## 6) Spot-check one expected player
```{r}
result %>% dplyr::filter(grepl("^GARY HUA", player_name))
```